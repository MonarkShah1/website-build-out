---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import RelatedServices from '../../components/RelatedServices.astro';
import CTASection from '../../components/CTASection.astro';
import type { CollectionEntry } from 'astro:content';

export const getStaticPaths: GetStaticPaths = async () => {
  const services = await getCollection('services');
  
  return services.map((service) => ({
    params: { slug: service.slug },
    props: { service },
  }));
};

interface Props {
  service: CollectionEntry<'services'>;
}

const { service } = Astro.props;
const { Content } = await service.render();

const canonicalURL = new URL(`/services/${service.slug}/`, Astro.site);

// Build keywords string from the keywords object
const keywordsString = [
  service.data.keywords?.primary,
  ...(service.data.keywords?.secondary || []),
  ...(service.data.keywords?.longtail || [])
].filter(Boolean).join(', ');

// Build JSON-LD schema
const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: service.data.title,
  description: service.data.metaDescription,
  provider: {
    '@type': 'Organization',
    name: 'Canadian Metal Fabricators',
    telephone: '+1-416-555-0100',
    address: {
      '@type': 'PostalAddress',
      addressLocality: 'Toronto',
      addressRegion: 'ON',
      addressCountry: 'CA'
    }
  },
  areaServed: service.data.schema?.areaServed || ['Toronto', 'GTA', 'Ontario'],
  serviceType: service.data.serviceType
};
---

<BaseLayout 
  title={service.data.title.substring(0, 60)}
  description={service.data.metaDescription}
  keywords={keywordsString}
  canonical={canonicalURL.toString()}
>
  <script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
  
  <Breadcrumbs items={[
    { label: 'Home', href: '/' },
    { label: 'Services', href: '/services/' },
    { label: service.data.title, href: `/services/${service.slug}/` }
  ]} />

  <article class="service-page">
    <header class="hero-section">
      <div class="container">
        <div class="hero-content">
          <h1 class="hero-title">{service.data.title}</h1>
          <p class="hero-description">{service.data.metaDescription}</p>
          
          <div class="hero-actions">
            <a href="#quote-form" class="btn btn-primary btn-lg">
              Get Instant Quote
            </a>
            <a href="tel:+14165550100" class="btn btn-secondary btn-lg">
              Call (416) 555-0100
            </a>
          </div>
        </div>
      </div>
    </header>

    <section class="content-section">
      <div class="container">
        <div class="content-grid">
          <main class="main-content">
            <Content />
            
            {service.data.materials && service.data.materials.length > 0 && (
              <section class="materials">
                <h2>Materials We Work With</h2>
                <ul class="materials-list">
                  {service.data.materials.map(material => (
                    <li>{material}</li>
                  ))}
                </ul>
              </section>
            )}

            {service.data.capabilities && service.data.capabilities.length > 0 && (
              <section class="capabilities">
                <h2>Our Capabilities</h2>
                <ul class="capabilities-list">
                  {service.data.capabilities.map(capability => (
                    <li>{capability}</li>
                  ))}
                </ul>
              </section>
            )}
          </main>

          <aside class="sidebar">
            <div class="sticky-sidebar">
              <div class="quick-quote-widget">
                <h3>Get a Quick Quote</h3>
                <p>Contact us for a free consultation on your {service.data.serviceType} project.</p>
                <a href="#quote-form" class="btn btn-primary btn-block">
                  Get Quote
                </a>
              </div>

              <div class="contact-widget">
                <h3>Need Help?</h3>
                <p>Our experts are ready to assist</p>
                <a href="tel:+14165550100" class="btn btn-outline btn-block">
                  (416) 555-0100
                </a>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <CTASection 
      title={`Ready to Start Your ${service.data.title} Project?`}
      description="Get an instant quote or speak with our experts"
      primaryAction={{ text: 'Get Instant Quote', href: '#quote-form' }}
      secondaryAction={{ text: 'Call (416) 555-0100', href: 'tel:+14165550100' }}
    />

    <RelatedServices currentService={service.slug} />
  </article>
</BaseLayout>

<style>
  .service-page {
    padding-top: var(--header-height);
  }

  .hero-section {
    background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-primary-100) 100%);
    padding: 4rem 0;
  }

  .hero-content {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }

  .hero-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 1rem;
    color: var(--color-primary-900);
  }

  .hero-description {
    font-size: 1.25rem;
    color: var(--color-primary-700);
    margin-bottom: 2rem;
  }

  .hero-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .content-section {
    padding: 3rem 0;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
  }

  .main-content {
    min-width: 0;
  }

  .materials,
  .capabilities {
    margin-top: 3rem;
  }

  .materials h2,
  .capabilities h2 {
    margin-bottom: 1.5rem;
    color: var(--color-primary-800);
  }

  .materials-list,
  .capabilities-list {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .materials-list li,
  .capabilities-list li {
    padding: 0.75rem 1rem;
    background: var(--color-gray-50);
    border-radius: 0.5rem;
    border-left: 3px solid var(--color-primary-500);
  }

  .sticky-sidebar {
    position: sticky;
    top: calc(var(--header-height) + 2rem);
  }

  .quick-quote-widget,
  .contact-widget {
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .quick-quote-widget h3,
  .contact-widget h3 {
    margin-bottom: 0.5rem;
    color: var(--color-primary-700);
  }

  .quick-quote-widget p,
  .contact-widget p {
    margin-bottom: 1rem;
    color: var(--color-gray-600);
  }

  .btn-block {
    display: block;
    width: 100%;
    text-align: center;
  }

  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
    }

    .sticky-sidebar {
      position: static;
    }
  }

  @media (max-width: 640px) {
    .hero-actions {
      flex-direction: column;
      align-items: center;
    }

    .hero-actions .btn {
      width: 100%;
      max-width: 300px;
    }
  }
</style>